{% extends 'store/base.html' %}
{% load static %} {# Good practice, even if not directly used in this specific file's content block #}

{% block title %}Send Due Reminders{% endblock title %}

{% block stylesheets %}
    {{ block.super }} {# Includes stylesheets from base.html #}
    <!-- Page-specific styles -->
    <style>
        /*
           Styles from your target file are kept here.
           Bootstrap 5 is already included via base.html, so many basic styles
           for body, container, h1, form-group, label will be influenced by Bootstrap.
           We can refine these further if needed, but this preserves your structure.
        */
        .top-left-button-container {
            margin-bottom: 20px;
            padding-left: 1rem; /* Align with typical container padding */
            padding-top: 1rem;
        }
        /* Override container margin if needed for this specific page, or rely on base.html's content padding */
        .reminders-container { /* Using a more specific class to avoid conflict with Bootstrap's .container */
            max-width: 700px; /* Slightly wider for better layout */
            margin: 0 auto 20px auto;
            padding: 20px;
            background-color: #fff; /* Assuming content area is white */
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1); /* Consistent shadow */
        }
        .reminders-container h1 {
            color: #333;
            text-align: center;
            margin-bottom: 25px;
            font-size: 1.75rem; /* Responsive heading size */
        }
        .form-group { /* Bootstrap already styles form-groups well, but keeping for specificity if needed */
            margin-bottom: 1rem;
        }
        .button-group {
            margin-top: 20px;
            display: flex;
            flex-direction: column; /* Stack buttons on small screens */
            gap: 10px;
        }
        @media (min-width: 576px) { /* Apply side-by-side for sm screens and up */
            .button-group {
                flex-direction: row;
                justify-content: space-between;
            }
            .button-group button {
                width: auto; /* Allow buttons to size based on content */
                flex: 1; /* Make buttons share space equally */
            }
            .button-group button + button {
                margin-left: 10px; /* Add space between buttons when side-by-side */
            }
        }

        .due-amount-display {
            margin-top: 10px;
            padding: 10px;
            background-color: #e9ecef; /* Standard Bootstrap light gray */
            border: 1px solid #ced4da; /* Standard Bootstrap border */
            border-radius: .25rem; /* Bootstrap's default border-radius */
        }
        /* Status messages will use Bootstrap alert classes, defined in JS */
    </style>
{% endblock stylesheets %}

{% block content %}
<div class="container-fluid px-2 px-md-4 py-3 py-md-5"> {# Use container-fluid for full width content area like dashboard #}
    <div class="top-left-button-container">
        <a href="{% url 'dashboard' %}" class="btn btn-success btn-sm"> {# Made button smaller for consistency #}
            <i class="fas fa-home me-2"></i>Back to Home
        </a>
    </div>

    <div class="reminders-container"> {# Changed class name #}
        <h1>Send Due Payment Reminders</h1>

        <div class="form-group">
            <label for="customer_select" class="form-label">Select Customer:</label> {# Added form-label for Bootstrap styling #}
            <select id="customer_select" class="form-select">
                <option value="">-- Select a Customer --</option>
                {% for customer in customers %}
                <option value="{{ customer.id }}">{{ customer.get_full_name }} ({{ customer.email|default:"No Email" }})</option>
                {% endfor %}
            </select>
        </div>

        <div id="due_amount_container" class="due-amount-display" style="display: none;">
            <strong>Amount Due:</strong> <span id="due_amount_value"></span>
        </div>

        <div class="button-group">
            <button id="send_single_button" class="btn btn-primary" disabled>Send to Selected Customer</button>
            <button id="send_all_button" class="btn btn-info">Send to All Due Customers</button> {# Changed to btn-info for variety #}
        </div>

        {# Status messages will use Bootstrap alert classes, applied via JS #}
        <div id="status_message_area" role="alert" style="display: none;"></div>
    </div>
</div>
{% endblock content %}

{% block javascripts %}
    {{ block.super }} {# Includes JavaScript from base.html (like jQuery and Bootstrap bundle) #}
    <script>
        document.addEventListener('DOMContentLoaded', function() { // Ensure DOM is ready
            // CSRF token for AJAX POST requests (Django standard way)
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }
            const csrftoken = getCookie('csrftoken');

            const customerSelect = document.getElementById('customer_select');
            const dueAmountContainer = document.getElementById('due_amount_container');
            const dueAmountValue = document.getElementById('due_amount_value');
            const sendSingleButton = document.getElementById('send_single_button');
            const sendAllButton = document.getElementById('send_all_button');
            const statusMessageArea = document.getElementById('status_message_area');

            function displayStatusMessage(message, type = 'info') {
                statusMessageArea.textContent = message;
                // Using Bootstrap alert classes
                statusMessageArea.className = 'alert mt-3'; // Base class and margin
                if (type === 'success') statusMessageArea.classList.add('alert-success');
                else if (type === 'error') statusMessageArea.classList.add('alert-danger');
                else if (type === 'warning') statusMessageArea.classList.add('alert-warning');
                else statusMessageArea.classList.add('alert-info'); // Default to info
                statusMessageArea.style.display = 'block';
            }

            customerSelect.addEventListener('change', function() {
                const customerId = this.value;
                sendSingleButton.disabled = true; // Disable button initially
                dueAmountContainer.style.display = 'none'; // Hide due amount
                statusMessageArea.style.display = 'none'; // Hide previous messages

                if (customerId) {
                    dueAmountValue.textContent = 'Loading...';
                    dueAmountContainer.style.display = 'block';

                    fetch(`/notifications/get-customer-due-amount/${customerId}/`, {
                        method: 'GET',
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest',
                            'Accept': 'application/json',
                            'X-CSRFToken': csrftoken // Good practice to send CSRF for GET if server checks, though not typical
                        }
                    })
                    .then(response => {
                        if (!response.ok) throw new Error(`Network response was not ok (${response.status})`);
                        return response.json();
                    })
                    .then(data => {
                        if (data.error) {
                            displayStatusMessage('Error: ' + data.error, 'error');
                            dueAmountContainer.style.display = 'none';
                        } else {
                            const dueAmount = parseFloat(data.due_amount);
                            dueAmountValue.textContent = 'Rs. ' + dueAmount.toFixed(2);
                            dueAmountContainer.style.display = 'block';
                            sendSingleButton.disabled = dueAmount <= 0;
                            if (dueAmount <= 0) {
                                displayStatusMessage( (data.customer_name || 'This customer') + ' has no outstanding dues.', 'info');
                            } else {
                                statusMessageArea.style.display = 'none'; // Clear if previously shown no dues
                            }
                        }
                    })
                    .catch(error => {
                        displayStatusMessage('Failed to fetch due amount. ' + error.message, 'error');
                        dueAmountContainer.style.display = 'none';
                    });
                }
            });

            sendSingleButton.addEventListener('click', function() {
                const customerId = customerSelect.value;
                if (!customerId) {
                    displayStatusMessage('Please select a customer.', 'warning');
                    return;
                }
                
                displayStatusMessage('Sending email...', 'info');
                sendSingleButton.disabled = true;
                sendAllButton.disabled = true;

                fetch(`{% url 'notifications:send_due_reminders_page' %}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': csrftoken 
                    },
                    body: JSON.stringify({ action: 'send_single', customer_id: customerId })
                })
                .then(response => response.json())
                .then(data => {
                    displayStatusMessage(data.message || data.error, data.status || (data.error ? 'error' : 'info'));
                    if(data.status === 'success' || data.status === 'info') {
                        customerSelect.dispatchEvent(new Event('change')); // Re-evaluate after action
                    } else {
                        const currentDueText = dueAmountValue.textContent.replace('Rs. ','').replace('Loading...','0');
                        const currentDue = parseFloat(currentDueText);
                        sendSingleButton.disabled = isNaN(currentDue) || currentDue <= 0;
                    }
                })
                .catch(error => {
                    displayStatusMessage('Request failed: ' + error.message, 'error');
                    const currentDueText = dueAmountValue.textContent.replace('Rs. ','').replace('Loading...','0');
                    const currentDue = parseFloat(currentDueText);
                    sendSingleButton.disabled = isNaN(currentDue) || currentDue <= 0;
                })
                .finally(() => {
                    sendAllButton.disabled = false;
                });
            });

            sendAllButton.addEventListener('click', function() {
                if (!confirm("Are you sure you want to send reminder emails to ALL customers with outstanding payments?")) {
                    return;
                }
                displayStatusMessage('Processing... Sending emails to all due customers. This may take a moment.', 'info');
                sendAllButton.disabled = true;
                sendSingleButton.disabled = true;

                fetch(`{% url 'notifications:send_due_reminders_page' %}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': csrftoken
                    },
                    body: JSON.stringify({ action: 'send_all' })
                })
                .then(response => response.json())
                .then(data => {
                    displayStatusMessage(data.message || data.error, data.status || (data.error ? 'error' : 'info'));
                    if (customerSelect.value) {
                        customerSelect.dispatchEvent(new Event('change')); // Re-evaluate selected customer's status
                    } else {
                        sendSingleButton.disabled = true;
                    }
                })
                .catch(error => {
                    displayStatusMessage('Request failed: ' + error.message, 'error');
                    if (customerSelect.value) {
                        const currentDueText = dueAmountValue.textContent.replace('Rs. ','').replace('Loading...','0');
                        const currentDue = parseFloat(currentDueText);
                        sendSingleButton.disabled = isNaN(currentDue) || currentDue <= 0;
                    } else {
                        sendSingleButton.disabled = true;
                    }
                })
                .finally(() => {
                    sendAllButton.disabled = false;
                });
            });
        });
    </script>
{% endblock javascripts %}